name: CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: 
          - DataIngestion.API
          - QualityAnalytics.API
          - AlertNotification.API
          - Dashboard.API
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore src/${{ matrix.service }}/${{ matrix.service }}.csproj
    
    - name: Build
      run: dotnet build src/${{ matrix.service }}/${{ matrix.service }}.csproj --configuration Release --no-restore
    
    - name: Test
      run: dotnet test src/${{ matrix.service }}/${{ matrix.service }}.csproj --configuration Release --no-build --verbosity normal || echo "No tests found"

  docker-build:
    runs-on: ubuntu-latest
    needs: build
    
    strategy:
      matrix:
        service: 
          - DataIngestion.API
          - QualityAnalytics.API
          - AlertNotification.API
          - Dashboard.API
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t visionflow/${{ matrix.service }}:${{ github.sha }} -f src/${{ matrix.service }}/Dockerfile src/${{ matrix.service }}
    
    - name: Test Docker image
      run: |
        docker run -d --name test-container -p 5000:500${{ strategy.job-index }} visionflow/${{ matrix.service }}:${{ github.sha }}
        sleep 10
        docker logs test-container
        docker stop test-container
        docker rm test-container
