name: CI/CD Test - Simulated Failure

# This workflow is for testing the Failure Analysis Agent
# It simulates a failure in the build stage

on:
  workflow_dispatch:
    inputs:
      fail_stage:
        description: 'Which stage should fail?'
        required: true
        default: 'build'
        type: choice
        options:
          - none
          - build
          - test
          - docker
          - compose
          - k8s

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      build-status: ${{ steps.build-step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application
        id: build-step
        run: |
          echo "Building application..."
          if [ "${{ github.event.inputs.fail_stage }}" == "build" ]; then
            echo "❌ Simulating build failure"
            exit 1
          fi
          echo "✅ Build completed successfully"

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    outputs:
      test-status: ${{ steps.test-step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests
        id: test-step
        run: |
          echo "Running tests..."
          if [ "${{ github.event.inputs.fail_stage }}" == "test" ]; then
            echo "❌ Simulating test failure"
            exit 1
          fi
          echo "✅ Tests completed successfully"

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    outputs:
      docker-status: ${{ steps.docker-step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        id: docker-step
        run: |
          echo "Building Docker image..."
          if [ "${{ github.event.inputs.fail_stage }}" == "docker" ]; then
            echo "❌ Simulating Docker build failure"
            exit 1
          fi
          echo "✅ Docker build completed successfully"

  docker-compose:
    name: Docker Compose
    runs-on: ubuntu-latest
    needs: docker-build
    outputs:
      compose-status: ${{ steps.compose-step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services with Docker Compose
        id: compose-step
        run: |
          echo "Starting Docker Compose services..."
          if [ "${{ github.event.inputs.fail_stage }}" == "compose" ]; then
            echo "❌ Simulating Docker Compose failure"
            exit 1
          fi
          echo "✅ Docker Compose services started successfully"

  kubernetes-deploy:
    name: Kubernetes Deploy
    runs-on: ubuntu-latest
    needs: docker-compose
    outputs:
      k8s-status: ${{ steps.k8s-step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Kubernetes
        id: k8s-step
        run: |
          echo "Deploying to Kubernetes..."
          if [ "${{ github.event.inputs.fail_stage }}" == "k8s" ]; then
            echo "❌ Simulating Kubernetes deployment failure"
            exit 1
          fi
          echo "✅ Kubernetes deployment completed successfully"

  notify-status:
    name: Notify Pipeline Status
    runs-on: ubuntu-latest
    needs: [build, test, docker-build, docker-compose, kubernetes-deploy]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze and report failures
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          BUILD_STATUS: ${{ needs.build.result }}
          TEST_STATUS: ${{ needs.test.result }}
          DOCKER_STATUS: ${{ needs.docker-build.result }}
          COMPOSE_STATUS: ${{ needs.docker-compose.result }}
          K8S_STATUS: ${{ needs.kubernetes-deploy.result }}
        run: |
          chmod +x .github/scripts/failure-analysis.sh
          .github/scripts/failure-analysis.sh
